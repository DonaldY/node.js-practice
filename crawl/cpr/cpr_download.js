const http = require('http');
const fs = require('fs');
const path = require('path');

const XLS_JSON = "[{\"year\":\"2023\",\"list\":[\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4899539/2023031811100388812.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4899530/2023031811074394721.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4966286/2023041811334097978.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/5037151/2023051818212261169.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/5100361/2023061811191521329.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/5157771/2023071811442311367.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/5247923/2023081811503192782.xls\"]},{\"year\":\"2022\",\"list\":[\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4248127/2022031816114432722.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4249383/2022031817305595244.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4296319/2022041811554654286.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4348589/2022051817160371742.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4405247/2022061717540328739.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4471482/2022071814220542127.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4527453/2022081811253650544.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4582851/2022091810184194656.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4635783/2022102410460186106.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4687321/2022111814333316366.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4747622/2022121810551359974.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4807001/2023011814435248949.xls\"]},{\"year\":\"2021\",\"list\":[\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3583748/2021031816175027078.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3583623/2021031816010553654.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3626138/2021041810310824345.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3673015/2021051817284190285.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3721177/2021061811214018147.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3769739/2021071810532911590.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3820957/2021081814465529939.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3890740/2021091815154852360.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3955405/2021101814062510689.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4006833/2021111814541553094.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4071086/2021121812191094688.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4127886/2022011814531099123.xls\"]},{\"year\":\"2020\",\"list\":[\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3517520/2021011916152461203.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3517672/2021011916384072460.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3017217/2020071608515662707.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3073822/2020071515393523510.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3155198/2020071317433776791.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3201745/2020072313444015987.xls\",\"/eportal/fileDir/defaultCurSite/resource/cms/2020/08/2020082419123333658.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3299214/2020092318014348913.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3336574/2020102315002727966.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3395638/2020112316372697447.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3479951/2020122322053428803.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3516030/2021011819081510998.xls\"]}]";
// const XLS_JSON = "[{\"year\":\"2023\",\"list\":[\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4899526/2023031811062323227.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4899551/2023031812413939170.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4966289/2023041811384522181.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/5037366/2023051819135542592.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/5100362/2023061810024344538.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/5157789/2023071811524155679.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/5248010/2023081811515550036.xls\"]},{\"year\":\"2022\",\"list\":[\"/customs/resource/cms/2022/12/2022122618163286056.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4249439/2022122618063927535.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4296331/2022122617574369059.xls\",\"/customs/resource/cms/2022/12/2022122617504468696.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4405256/2022122617452397099.xls\",\"/customs/resource/cms/2022/12/2022122618320580436.xls\",\"/customs/resource/cms/2022/12/2022122617293518722.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4582858/2022122617225626520.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4635791/2022122617120283503.xls\",\"/customs/resource/cms/2022/12/2022122617055514439.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4747626/2022121810570388661.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4807029/2023011814493636367.xls\"]},{\"year\":\"2021\",\"list\":[\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3583783/2021031816212550540.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3583635/2021031816025799186.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3626146/2021041810333034068.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3673043/2021051817281889981.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3721188/2021061811242287266.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3769744/2021071810562788654.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3820987/2021081814494587969.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3890865/2021091815181871118.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3955450/2021101814101320343.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4006865/2021111814571339637.xls\",\"/customs/resource/cms/2023/02/2023020810500269253.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4127968/2023020810423740556.xls\"]},{\"year\":\"2020\",\"list\":[\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3517542/2021011916194863435.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3517702/2021011916415287691.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3017224/2020071608510042940.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3073826/2020071515391192072.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3155203/2020071317430410857.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3201752/2020072313471149588.xls\",\"/eportal/fileDir/defaultCurSite/resource/cms/2020/08/2020082419125355640.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3299221/2020092318032548386.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3336586/2020102315020062165.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3395651/2020112316385792669.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3479955/2020122322055435993.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3516038/2021011819132857623.xls\"]}]";
// const XLS_JSON = "[{\"year\":\"2023\",\"list\":[\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4899384/2023031810180720498.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4899405/2023031810260379556.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4966195/2023041811062883554.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/5037187/2023051817254790742.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/5100312/2023061809372582591.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/5157587/2023071811161196009.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/5247323/2023081811183624970.xls\"]},{\"year\":\"2022\",\"list\":[\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4245938/2022031814323239831.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4248460/2022031816365324639.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4296165/2022041811343885019.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4348368/2022051810580472561.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4405113/2022061717123844725.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4471079/2022071811072721003.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4527277/2022081810540310823.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4582760/2022091809591556411.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4635747/2022102408580582697.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4686771/2022111811554271106.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4747570/2022121810261829144.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4806921/2023011811504355125.xls\"]},{\"year\":\"2021\",\"list\":[\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3583175/2021031814594716208.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3584379/2021031819382031084.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3625966/2021041809464977002.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3672606/2021051817211546556.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3719465/2021061809541471421.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3769536/2021071809455973755.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3819870/2021081808590824030.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3890117/2021091814271866639.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3954291/2021101810541240819.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4005510/2021111810163073554.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4070923/2021121810431148340.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/4127562/2022011811072936276.xls\"]},{\"year\":\"2020\",\"list\":[\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3516576/2021011911574734235.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3517459/2021011916052753223.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3017125/2020071608581145221.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3073744/2020071515454314890.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3155088/2020071317481610805.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3201603/2020072312005678354.xls\",\"/eportal/fileDir/defaultCurSite/resource/cms/2020/08/2020082419073357766.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3299032/2020092317333014016.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3336297/2020102314311339093.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3395261/2020112316070689198.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3479797/2020122322011846348.xls\",\"/customs/302249/zfxxgk/2799825/302274/302277/302276/3515644/2021011816101330416.xls\"]}]";
const FOLDER_PATH = '/Users/yangyf/Downloads/CPR-14';
// const FOLDER_PATH = '/Users/yangyf/Downloads/CPR-15';
// const FOLDER_PATH = '/Users/yangyf/Downloads/CPR-2';
const XLS_DOMAIN = "http://www.customs.gov.cn";

async function main() {
    await doMain();
    sleep(100000);
}

async function doMain() {
    let yearXlsList = JSON.parse(XLS_JSON);
    for (let yearXls of yearXlsList) {
        let year = yearXls.year;
        let xlsList = yearXls.list;
        console.log(year + ' 数据列表长度：' + xlsList.length);

        const folderPath = `${FOLDER_PATH}/${year}`;

        fs.mkdir(folderPath, { recursive: true }, (err) => {
            if (err) {
                console.error(`创建文件夹 ${folderPath} 时遇到错误：${err}`);
            } else {
                console.log(`文件夹 ${folderPath} 创建成功！`);

                for (let xlsUrl of xlsList) {
                    downLoadFile(xlsUrl, folderPath);
                }
            }
        });
    }
}

function sleep(ms) {
    return new Promise((resolve) => setTimeout(resolve, ms));
}

async function downLoadFile(fileUrl, destinationFolder) {
    // 从 URL 中提取文件名
    const fileName = path.basename(fileUrl);

    // 创建写入流
    const file = fs.createWriteStream(path.join(destinationFolder, fileName));

    const options = {
        hostname: 'www.customs.gov.cn',
        path: fileUrl,
        method: 'GET',
        "headers": {
            "accept": "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9",
            "accept-language": "zh-CN,zh;q=0.9",
            "cache-control": "no-cache",
            "pragma": "no-cache",
            "upgrade-insecure-requests": "1",
            "cookie": "__jsluid_h=4ea0888207d248cdded5e15a6d3e948c; AV7KYchI7HHaS=5vSS23w2EY0KcQiSGsc9cSOUcNav7GU6TABi0hEf4nqcJWWxLhaEE_iloIX8Mkxsydb6EvDYVTcqH3tmfxy4WAq; _gscu_1524496263=88991451i43clr19; AV7KYchI7HHaT=rKsZBYseMUzm0raLXQBNVIBE4.jrOfY.mUoICmX4FUNpGwBi7uAPTrC8KlWY_fPlXpgMSW9cgZQxu4QJ29R1EBMF6Uhn04RiuyB3R3YbT1WDbzEi.fNlHiMQO3mmYc34iWeoBPyPOgV8BmMTMP.sLRZOUMf0zosqjlS9gLpogjetue43A_rJneymsZApIRvOPA67nWdVperobEe8jMSlvQDtcmrcJiB7wSly8BaLiImxmrFT1mr_iHZ1VeddA0Vqu.kbSvCjexjAYZQFJf34AiOMpTOzs38m8tmPVI2oYGRXXFEKAD9dSQhLgpvlE_kA60JwvXzouuM6J3Xza.8ADaDKNKjO85x6ruIt4Z0XLq0; __jsl_clearance=1692346851.47|0|5om3cp7J%2FomqQJcnF%2BhG%2BPSwNJQ%3D",
            //"Referer": "http://www.customs.gov.cn/customs/302249/zfxxgk/2799825/302274/302277/302276/4245830/2022031814252873524.xls",
            "Referrer-Policy": "strict-origin-when-cross-origin"
        }
    };

    // 发起 HTTP GET 请求
    http.get(options, (response) => {
        response.pipe(file);

        file.on('finish', () => {
            file.close();
            console.log('文件下载完成！: ' + fileName);
        });
    }).on('error', (err) => {
        // 删除已下载的文件
        // fs.unlinkSync(path.join(destinationFolder, fileName));
        console.error(`下载文件时遇到错误：${err} , ${fileName}`);
    });
}

main();
